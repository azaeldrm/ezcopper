services:
  ezcopper:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ezcopper
    ports:
      - "6080:6080"  # noVNC
      - "8000:8000"  # FastAPI - main API
      - "8001:8001"  # Rules UI
    volumes:
      - ./data:/data
    environment:
      - MODE=${MODE:-bootstrap}
      - DISCORD_CHANNEL_URLS=${DISCORD_CHANNEL_URLS:-}
      - DISCORD_CHANNEL_URL=${DISCORD_CHANNEL_URL:-}
      - WHITELIST_CHANNEL_URLS=${WHITELIST_CHANNEL_URLS:-}
      - BLACKLIST_CHANNEL_URLS=${BLACKLIST_CHANNEL_URLS:-}
      - KEYWORDS=${KEYWORDS:-}
      - URL_REGEX=${URL_REGEX:-}
      - CONFIRM_FINAL_ORDER=${CONFIRM_FINAL_ORDER:-true}
      - POLL_INTERVAL_SECONDS=${POLL_INTERVAL_SECONDS:-5.0}
      - DRY_RUN=${DRY_RUN:-false}
      # Amazon flow timing - TIMEOUT_* = max wait (proceeds when ready), WAIT_* = fixed sleep
      - TIMEOUT_MS_PAGE_LOAD=${TIMEOUT_MS_PAGE_LOAD:-30000}
      - TIMEOUT_MS_ELEMENT_VISIBLE=${TIMEOUT_MS_ELEMENT_VISIBLE:-10000}
      - TIMEOUT_MS_SELECTOR_CHECK=${TIMEOUT_MS_SELECTOR_CHECK:-150}
      - TIMEOUT_MS_AOD_PANEL=${TIMEOUT_MS_AOD_PANEL:-10000}
      - TIMEOUT_MS_CHECKOUT_LOAD=${TIMEOUT_MS_CHECKOUT_LOAD:-30000}
      - TIMEOUT_SECONDS_ORDER_CONFIRM=${TIMEOUT_SECONDS_ORDER_CONFIRM:-300}
      - WAIT_SECONDS_DYNAMIC_CONTENT=${WAIT_SECONDS_DYNAMIC_CONTENT:-2.0}
      - WAIT_SECONDS_CART_UPDATE=${WAIT_SECONDS_CART_UPDATE:-2.0}
      - WAIT_SECONDS_CHECKOUT_TRANSITION=${WAIT_SECONDS_CHECKOUT_TRANSITION:-3.0}
      - MAX_RETRIES=${MAX_RETRIES:-3}
      - DELAY_SECONDS_RETRY=${DELAY_SECONDS_RETRY:-0.5}
      - VNC_PASSWORD=${VNC_PASSWORD:-}
      - DISPLAY=:99
    shm_size: "1gb"
    restart: unless-stopped
    stop_grace_period: ${STOP_GRACE_PERIOD:-10s}
